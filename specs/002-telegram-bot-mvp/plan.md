# Implementation Plan: SkillTree Telegram Bot MVP

**Branch**: `002-telegram-bot-mvp` | **Date**: 2025-12-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature spec from `/specs/002-telegram-bot-mvp/spec.md`

**Note**: Plan generated by `/speckit.plan` command.

---

## Summary

Build a **Telegram bot for career guidance testing** of Russian teenagers (14-17 years). The bot implements a 55-question RIASEC career assessment with FSM-based state management (NOT conversations plugin), complete gamification system (points, badges, weekly streaks), radar chart visualization using local Chart.js + @napi-rs/canvas, parent email reports via SendPulse (12K free/month), and referral mechanics for viral growth.

**Core Technical Decisions**:
- **Bot Framework**: grammY with Database-Driven FSM (NOT @grammyjs/conversations)
- **State Management**: PostgreSQL-based instruction pointer pattern
- **Email**: SendPulse (12K free/month, Node.js SDK, best value)
- **Charts**: Chart.js + @napi-rs/canvas (local generation, no external API quotas)
- **Architecture**: Monorepo with apps/bot + apps/api + packages/database

---

## Technical Context

| Attribute | Value |
|-----------|-------|
| **Language/Version** | TypeScript 5.x, Node.js 18+ |
| **Primary Dependencies** | grammY 1.21+, NestJS 10+, Prisma 5+, chart.js 4.4+, @napi-rs/canvas 0.1.44+ |
| **Storage** | PostgreSQL 15+ (Supabase Cloud) |
| **Testing** | Vitest (unit), integration tests (manual for MVP) |
| **Target Platform** | VDS Ubuntu 20.04+, 2GB RAM |
| **Project Type** | Monorepo (Turborepo + pnpm) |
| **Performance Goals** | <2s response time, 100 charts/min capacity, 10K concurrent users |
| **Constraints** | 2GB RAM budget (~400MB peak), 152-FZ compliance for emails, no external chart API quotas |
| **Scale/Scope** | MVP: 10K users, 55-question test, 43 careers database |

---

## Constitution Check

*GATE: Must pass before Phase 0. Re-check after Phase 1.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Context-First Development** | PASS | Comprehensive research completed (RIASEC, grammY architecture, tech stack) |
| **II. Agent-Based Orchestration** | PASS | Complex tasks will be delegated to specialized subagents |
| **III. Test-Driven Development** | N/A | Tests not explicitly required in spec, optional |
| **IV. Atomic Task Execution** | PLANNED | Tasks will be atomic and committable |
| **V. User Story Independence** | PASS | 8 independent user stories defined in spec.md |
| **VI. Quality Gates** | PLANNED | Type-check + build must pass before commits |
| **VII. Progressive Specification** | IN_PROGRESS | Phase 0-1 planning, Phase 2 (tasks) next |
| **Security Requirements** | PLANNED | Email encryption, consent, SendPulse for emails |
| **Technology Standards** | PASS | Using approved stack (grammY, NestJS, Prisma, Supabase) |

---

## Project Structure

### Documentation (this feature)

```text
specs/002-telegram-bot-mvp/
├── spec.md              # User stories and requirements
├── plan.md              # This file (implementation plan)
├── technical-requirements.md  # Detailed technical spec
├── research.md          # Phase 0 output (below)
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (API specs)
│   ├── bot-commands.md
│   └── api-endpoints.md
├── checklists/          # QA checklists
│   └── requirements.md
└── tasks.md             # Phase 2 output (/speckit.tasks)
```

### Source Code (repository root)

```text
# Monorepo Structure (Turborepo + pnpm)

apps/
├── api/                 # NestJS API (existing)
│   ├── src/
│   │   ├── modules/
│   │   │   ├── results/           # NEW: Results visualization
│   │   │   │   ├── results.controller.ts
│   │   │   │   ├── results.service.ts
│   │   │   │   ├── chart.service.ts
│   │   │   │   └── card.service.ts
│   │   │   ├── email/             # NEW: SendPulse integration
│   │   │   │   ├── email.controller.ts
│   │   │   │   ├── email.service.ts
│   │   │   │   └── templates/
│   │   │   ├── careers/           # NEW: Career matching
│   │   │   │   └── careers.service.ts
│   │   │   └── gamification/      # NEW: Points, badges, streaks
│   │   │       ├── gamification.service.ts
│   │   │       ├── streak.service.ts
│   │   │       └── achievement.service.ts
│   │   └── assets/
│   │       └── fonts/             # Inter + Noto Color Emoji
│   └── package.json
│
├── bot/                 # NEW: grammY Telegram Bot
│   ├── src/
│   │   ├── bot.ts                 # Main entry, middleware
│   │   ├── content/               # Question bank data
│   │   │   └── questions.ts
│   │   ├── handlers/
│   │   │   ├── start.handler.ts
│   │   │   ├── quiz.handler.ts
│   │   │   ├── results.handler.ts
│   │   │   ├── streak.handler.ts
│   │   │   ├── referral.handler.ts
│   │   │   └── parent.handler.ts
│   │   ├── keyboards/
│   │   │   ├── main-menu.ts
│   │   │   ├── question.ts
│   │   │   └── results.ts
│   │   ├── services/
│   │   │   ├── user.service.ts
│   │   │   ├── quiz.service.ts
│   │   │   ├── gamification.service.ts
│   │   │   └── referral.service.ts
│   │   └── utils/
│   │       ├── formatters.ts
│   │       └── validators.ts
│   └── package.json
│
packages/
├── database/            # Prisma schema (existing, needs extensions)
│   ├── prisma/
│   │   └── schema.prisma
│   └── src/
│       └── index.ts
├── shared/              # Shared types/utils (existing)
│   └── src/
│       ├── types/
│       │   ├── riasec.ts          # NEW: RIASEC type definitions
│       │   └── gamification.ts    # NEW: Points, badges types
│       └── constants/
│           └── riasec.ts          # NEW: RIASEC norms, colors
└── config/              # Config packages (existing)
```

**Structure Decision**: Extend existing monorepo with new `apps/bot` package. API modules added to existing `apps/api`.

---

## Complexity Tracking

> No constitution violations identified. All complexity is justified by functional requirements.

| Complexity | Justification | Alternative Considered |
|------------|---------------|------------------------|
| FSM over Conversations | grammY conversations plugin doesn't survive restarts; 55-question flow MUST resume | Could use conversations but would break on deploys |
| Local chart generation | QuickChart free tier (1K/month) exhausted in 1 busy day | External API with paid tier ($20+/mo) |
| SendPulse over NotiSend | 6x more free emails (12K vs 2K), Node.js SDK, better quality score | NotiSend has Russian DC but fewer free emails |

---

## Research Summary (Phase 0)

Research completed via previous deep research. Key findings documented below.

### R-001: Bot Architecture Decision

**Decision**: Database-Driven FSM
**Rationale**: grammY conversations plugin serializes execution stack. Server restart while user is on Q10 would crash their session.
**Implementation**: `currentStep` integer in PostgreSQL; bot is stateless event handler.
**Source**: [grammY Deep Think](../../docs/Deep%20Think/%20grammY%20Conversation%20Architecture%20(Deep%20Think).md)

### R-002: Email Provider Selection

**Decision**: SendPulse (sendpulse.com)
**Rationale**: Best value — **12,000 free emails/month** (6x more than NotiSend), Node.js SDK, higher quality score (8.55 vs 8.35). Servers abroad but significantly better value justifies the choice.
**Pricing**: 12,000 free/month, ~$8.85 for 10,000/month
**Fallback**: NotiSend (Russian DC, 2K free) if legal concerns arise
**Source**: [Tech Stack Research](../../docs/Research/SkillTree%20Bot%20MVP%20Technical%20Stack%20Recommendations.md)

### R-003: Chart Generation Stack

**Decision**: Chart.js + @napi-rs/canvas
**Rationale**: Zero system dependencies, 68 ops/sec, 15-25ms per chart, native color emoji support
**Memory**: ~20-50MB peak (fits 2GB VDS budget)
**Fallback**: skia-canvas (same API, drop-in replacement)
**Source**: [Tech Stack Research](../../docs/Research/SkillTree%20Bot%20MVP%20Technical%20Stack%20Recommendations.md)

### R-004: RIASEC Scoring Methodology

**Decision**: Pearson Correlation matching (O*NET standard)
**Rationale**: Gold standard per academic literature and U.S. Department of Labor
**Thresholds**: Best Fit ≥0.729, Great Fit 0.608-0.728, Good Fit 0-0.607, Poor Fit <0
**Source**: [RIASEC Research](../../docs/Research/RIASEC%20Career%20Assessment%20System%20for%20Russian%20Teenagers.md)

### R-005: Question Bank

**Decision**: 55 questions from riasec-seed-data.ts
**Format**: 9 per dimension + 1 buffer, interleaved (never same dimension consecutively)
**Mix**: 70% multiple choice, 20% rating, 10% binary
**Source**: [riasec-seed-data.ts](../../docs/Research/riasec-seed-data.ts)

### R-006: Career Database

**Decision**: 43 careers with Russian titles and RIASEC profiles
**Categories**: Technology (30%), Medicine/Science (20%), Creative (20%), Business (20%), Other (10%)
**Salaries**: From hh.ru 2024 data, in RUB
**Source**: [riasec-seed-data.ts](../../docs/Research/riasec-seed-data.ts)

---

## Database Schema Extensions (Phase 1)

The following models need to be added to `packages/database/prisma/schema.prisma`:

### New Models Required

```prisma
// Quiz session extended fields (already exists, needs update)
model TestSession {
  // ... existing fields ...
  currentStep    Int      @default(0)  // FSM instruction pointer
  answeredJSON   Json     @default("{}") // Answers as {questionId: value}
  reminderSentAt DateTime? // 12h reminder tracking
  updatedAt      DateTime @updatedAt
}

// Question options for multiple choice
model QuestionOption {
  id         String   @id @default(cuid())
  questionId String
  text       String
  emoji      String?
  value      String
  scores     Json     // RIASECScores
  order      Int

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  @@index([questionId])
}

// Career database
model Career {
  id              String   @id @default(cuid())
  title           String
  titleRu         String
  description     String
  riasecProfile   Json     // RIASECScores
  salaryMin       Int
  salaryMax       Int
  salarySource    String
  category        String
  requiredSkills  String[]
  educationPath   String[]
  universities    String[]
  outlook         CareerOutlook
  demandLevel     DemandLevel

  @@index([category])
}

// Test results storage
model TestResult {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  riasecProfile   Json     // Calculated scores
  topCareers      Json     // CareerMatch[]
  personalityType String
  radarChartUrl   String?
  shareCardUrl    String?
  createdAt       DateTime @default(now())

  session TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// Email verification for parents
model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  email     String
  code      String   // 4-digit
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([code])
}

// Parent link codes
model ParentLinkCode {
  id        String   @id @default(cuid())
  studentId String   @unique
  code      String   @unique // 6-char alphanumeric
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([code])
}

enum CareerOutlook {
  GROWING
  STABLE
  DECLINING
}

enum DemandLevel {
  HIGH
  MEDIUM
  LOW
}
```

### Existing Models Updates

```prisma
// Add to Question model
model Question {
  // ... existing fields ...
  riasecWeights Json?      // Primary and secondary dimensions
  isEasterEgg   Boolean    @default(false)
  hint          String?    // Easter egg hint text

  // Add relation
  options       QuestionOption[]
}

// Add to Parent model
model Parent {
  // ... existing fields ...
  emailVerified Boolean @default(false)
}

// Add to TestSession
model TestSession {
  // ... existing fields ...
  testResult TestResult?
}
```

---

## API Contracts (Phase 1)

### Bot Commands

| Command | Description | Handler |
|---------|-------------|---------|
| `/start` | Start bot / main menu | start.handler.ts |
| `/test` | Start new test | quiz.handler.ts |
| `/resume` | Continue test | quiz.handler.ts |
| `/results` | View results | results.handler.ts |
| `/streak` | Check streak status | streak.handler.ts |
| `/achievements` | View badges | streak.handler.ts |
| `/share` | Share results | results.handler.ts |
| `/linkcode` | Generate parent code (student) | parent.handler.ts |
| `/link <code>` | Link child (parent) | parent.handler.ts |
| `/help` | Help message | start.handler.ts |
| `/cancel` | Cancel current action | quiz.handler.ts |
| `/privacy` | Privacy policy | start.handler.ts |

### API Endpoints (NestJS)

| Method | Path | Description | Response |
|--------|------|-------------|----------|
| GET | `/results/:sessionId/radar-chart` | Get radar chart PNG | Buffer |
| GET | `/results/:sessionId/share-card` | Get shareable card PNG | Buffer |
| POST | `/results/:sessionId/email-report` | Send parent email | void |
| GET | `/results/:sessionId/careers` | Get career matches | CareerMatch[] |
| POST | `/email/verify` | Send verification code | void |
| POST | `/email/confirm` | Confirm verification code | boolean |
| GET | `/careers` | List all careers | Career[] |
| GET | `/careers/:id` | Get career details | Career |

---

## Dependencies to Install

### apps/bot/package.json

```json
{
  "dependencies": {
    "grammy": "^1.21.0",
    "@grammyjs/menu": "^1.2.0",
    "@grammyjs/ratelimiter": "^1.2.0",
    "date-fns": "^3.6.0",
    "@skilltree/database": "workspace:*",
    "@skilltree/shared": "workspace:*"
  }
}
```

### apps/api/package.json (additions)

```json
{
  "dependencies": {
    "@napi-rs/canvas": "^0.1.44",
    "chart.js": "^4.4.0",
    "axios": "^1.6.0",
    "sendpulse-api": "^1.1.6",
    "pdfkit": "^0.15.0"
  }
}
```

### Asset Files Required

```
apps/api/assets/fonts/
├── Inter-Regular.ttf
├── Inter-Medium.ttf
├── Inter-Bold.ttf
└── NotoColorEmoji.ttf

apps/api/assets/
└── logo.png (SkillTree logo for share cards)
```

---

## Environment Variables (additions)

```bash
# .env additions for 002-telegram-bot-mvp

# Telegram Bot
TELEGRAM_BOT_TOKEN=           # From @BotFather
TELEGRAM_BOT_USERNAME=skilltreebot

# SendPulse Email (12K free/month)
SENDPULSE_API_USER_ID=        # From sendpulse.com dashboard
SENDPULSE_API_SECRET=         # From sendpulse.com dashboard
SENDPULSE_FROM_EMAIL=noreply@skilltree.ru

# Feature Flags
ENABLE_EMAIL_REPORTS=true
ENABLE_SHAREABLE_CARDS=true
ENABLE_REFERRAL_SYSTEM=true

# Gamification
SESSION_TIMEOUT_HOURS=24
WEEKLY_RESET_TZ=Europe/Moscow
```

---

## Implementation Phases

### Phase 1: Foundation (User Stories depend on this)

1. Create `apps/bot` package structure
2. Configure grammY with long polling
3. Extend Prisma schema with new models
4. Run migrations
5. Seed question bank (55 questions)
6. Seed career database (43 careers)
7. Download and configure fonts

### Phase 2: User Story P1 - Core Test Flow

- US-1: Student Takes Career Assessment
- US-2: Student Earns Gamification Rewards
- US-6: Test Resume After Interruption
- US-8: Insight Teasers During Test

### Phase 3: User Story P1 - Results & Sharing

- US-3: Student Shares Results

### Phase 4: User Story P2 - Parent Features

- US-4: Parent Registration and Linking
- US-5: Parent Receives Email Report

### Phase 5: User Story P2 - Viral Mechanics

- US-7: Referral System

### Phase 6: Polish & Deployment

- Edge cases handling
- Rate limiting
- Error handling
- Logging (Pino structured JSON)
- PM2 configuration
- Production deployment

### Phase 7: PDF Roadmap (FR-037)

- PDFKit integration
- Career roadmap PDF generation
- 1000-point unlock gate
- Inter font for Russian text

### Phase 8: Data Retention & Privacy (FR-038, FR-039, FR-040)

- 3-year data retention policy
- User data anonymization (pg_cron/PM2)
- /deletedata command with 2-step confirmation
- Deletion audit logging

### Phase 9: Metrics & Observability (FR-036)

- Basic engagement metrics tracking
- Completion rate, DAU, average duration
- Internal admin API for metrics

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Session data loss during restart | Low | High | FSM pattern with DB persistence |
| QuickChart quota exceeded | N/A | N/A | Using local chart generation |
| SendPulse API issues | Low | Medium | Abstract interface for provider switching |
| Memory exhaustion on 2GB VDS | Low | High | ~400MB peak, PM2 max_memory_restart |
| 152-FZ concerns | Low | Low | Minimal PII in emails, fallback to NotiSend if needed |

---

## Success Criteria Validation

| Criteria | How Measured | Target |
|----------|--------------|--------|
| SC-001: Completion rate | completed/started tests | 70%+ |
| SC-002: Test duration | average session time | 12-15 min |
| SC-003: Section 1 drop-off | abandoned at Q1-11 | <5% |
| SC-004: Share rate | shares/completions | 30%+ |
| SC-012: Response time | bot reply latency | <2s |

---

## Next Steps

1. **Run `/speckit.tasks`** to generate tasks.md from this plan
2. **Create feature branch** `002-telegram-bot-mvp`
3. **Begin implementation** following atomic task execution pattern
4. **Commit after each task** with `/push patch`

---

**Plan Status**: READY FOR TASKS GENERATION
**Plan Author**: Claude Code Orchestrator
**Review Required**: User approval before proceeding to tasks.md
