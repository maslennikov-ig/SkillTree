name: Deploy Bot to VDS

on:
  push:
    branches: [main]
    paths:
      - 'apps/bot/**'
      - 'packages/database/**'
      - 'packages/shared/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even without changes'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  APP_DIR: '/opt/skilltree/repa-maks'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        # Version is auto-detected from package.json "packageManager" field

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm --filter @skilltree/database exec prisma generate

      - name: Build all packages
        run: pnpm build

      - name: Type-check bot
        run: pnpm --filter @skilltree/bot exec tsc --noEmit

  deploy:
    name: Deploy to VDS
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e
            echo "========================================="
            echo "Starting deployment at $(date)"
            echo "========================================="

            cd ${{ env.APP_DIR }}

            # Save current commit for rollback
            PREV_COMMIT=$(git rev-parse HEAD)
            echo "Previous commit: $PREV_COMMIT"

            # Pull latest changes
            echo "Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "New commit: $NEW_COMMIT"

            # Install dependencies
            echo "Installing dependencies..."
            pnpm install --frozen-lockfile

            # Generate Prisma client
            echo "Generating Prisma client..."
            pnpm --filter @skilltree/database exec prisma generate

            # Build packages
            echo "Building packages..."
            pnpm --filter @skilltree/shared build
            pnpm --filter @skilltree/bot build

            # Restart bot with PM2
            echo "Restarting bot..."
            pm2 restart skilltree-bot --update-env || pm2 start ecosystem.config.js --only skilltree-bot

            # Wait for bot to start
            sleep 5

            # Health check
            echo "Checking bot status..."
            if pm2 show skilltree-bot | grep -q "online"; then
              echo "✅ Bot is running!"
              pm2 logs skilltree-bot --lines 10 --nostream
            else
              echo "❌ Bot failed to start!"
              echo "Rolling back to $PREV_COMMIT..."
              git reset --hard $PREV_COMMIT
              pnpm install --frozen-lockfile
              pnpm --filter @skilltree/shared build
              pnpm --filter @skilltree/bot build
              pm2 restart skilltree-bot
              exit 1
            fi

            echo "========================================="
            echo "Deployment completed at $(date)"
            echo "========================================="

      - name: Deployment summary
        if: success()
        run: |
          echo "## Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** VDS (SkillTree Bot)" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: failure()
        run: |
          echo "## Deployment Failed! :x:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "Automatic rollback was attempted." >> $GITHUB_STEP_SUMMARY
